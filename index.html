<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podium Project Management - Contracts Edition</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .panel { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        button:hover { background: #0056b3; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .project-item { border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fafafa; }
        .project-item.active { border-left: 4px solid #28a745; }
        .project-item.draft { border-left: 4px solid #ffc107; }
        .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .tasks-section { background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; }
        .task-line { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .convert-btn { background: #28a745; font-size: 12px; }
        .total-bar { background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; text-align: right; font-weight: bold; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; }
        .tab.active { border-bottom: 2px solid #007bff; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Podium Project Management - Contracts & Invoices</h1>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('projects')">Projects</button>
            <button class="tab" onclick="showTab('contracts')">Contracts</button>
            <button class="tab" onclick="showTab('invoices')">Invoices</button>
            <button class="tab" onclick="showTab('tasks')">Tasks</button>
        </div>

        <!-- Projects Tab -->
        <div id="projects-tab" class="tab-content">
            <div class="section-title">
                <h2>Projects</h2>
                <button onclick="showCreateProject()" style="background: #28a745;">New Project</button>
            </div>
            
            <!-- Create Project -->
            <div id="create-project" style="display:none;" class="panel">
                <h3>Create Project</h3>
                <div class="form-group">
                    <input type="text" id="projectName" placeholder="Project Name">
                    <input type="text" id="clientName" placeholder="Client Name">
                    <input type="number" id="projectBudget" placeholder="Budget" step="0.01">
                    <button onclick="createProject()">Create Project</button>
                    <button onclick="hideCreateProject()" style="background: #6c757d;">Cancel</button>
                </div>
            </div>
            
            <div id="projects-list"></div>
        </div>

        <!-- Contracts Tab -->
        <div id="contracts-tab" class="tab-content" style="display:none;">
            <div class="section-title">
                <h2>Contracts</h2>
                <button onclick="showCreateContract()" style="background: #28a745;">New Contract</button>
            </div>
            
            <div id="create-contract" style="display:none;" class="panel">
                <h3>Create Contract</h3>
                <div class="form-group">
                    <select id="contractProject"></select>
                    <input type="text" id="contractTitle" placeholder="Contract Title">
                    <div id="contract-tasks">
                        <div class="task-input">
                            <input type="text" placeholder="Task Name">
                            <textarea placeholder="Task Description"></textarea>
                            <input type="number" placeholder="Fee" step="0.01">
                            <button onclick="removeContractTask(this)">Remove</button>
                        </div>
                    </div>
                    <button onclick="addContractTask()">Add Task</button>
                    <button onclick="createContract()">Create Contract</button>
                    <button onclick="hideCreateContract()" style="background: #6c757d;">Cancel</button>
                </div>
            </div>
            
            <div id="contracts-list"></div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoices-tab" class="tab-content" style="display:none;">
            <div class="section-title">
                <h2>Invoices</h2>
                <button onclick="showCreateInvoice()" style="background: #28a745;">New Invoice</button>
            </div>
            
            <div id="create-invoice" style="display:none;" class="panel">
                <h3>Create Invoice</h3>
                <div class="form-group">
                    <select id="invoiceProject"></select>
                    <select id="invoiceContract"></select>
                    <div id="invoice-tasks">
                        <!-- Tasks will be populated from contract -->
                    </div>
                    <button onclick="createInvoice()">Create Invoice</button>
                    <button onclick="hideCreateInvoice()" style="background: #6c757d;">Cancel</button>
                </div>
            </div>
            
            <div id="invoices-list"></div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks-tab" class="tab-content" style="display:none;">
            <div class="section-title">
                <h2>All Tasks</h2>
            </div>
            <div id="tasks-list"></div>
        </div>
    </div>

    <script>
        let currentData = { projects: [], contracts: [], invoices: [], tasks: [] };

        // Initialization
        fetchData();
        initDB();

        async function initDB() {
            await fetch('/api/init', { method: 'POST' });
            await fetchData();
        }

        async function fetchData() {
            currentData.projects = await (await fetch('/api/projects')).json();
            currentData.contracts = await (await fetch('/api/contracts')).json();
            currentData.invoices = await (await fetch('/api/invoices')).json();
            currentData.tasks = await (await fetch('/api/tasks')).json();
            
            renderAll();
            updateDropdowns();
        }

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
        }

        // Project management
        async function createProject() {
            const data = {
                name: document.getElementById('projectName').value,
                client_name: document.getElementById('clientName').value,
                budget: parseFloat(document.getElementById('projectBudget').value) || 0
            };
            await fetch('/api/projects', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            hideCreateProject();
            await fetchData();
        }

        // Contract management
        async function createContract() {
            const projectId = document.getElementById('contractProject').value;
            const taskInputs = document.querySelectorAll('#contract-tasks .task-input');
            const tasks = [];
            
            let total = 0;
            taskInputs.forEach(input => {
                const name = input.querySelector('input[type="text"]').value;
                const description = input.querySelector('textarea').value;
                const fee = parseFloat(input.querySelector('input[type="number"]').value) || 0;
                if (name && fee > 0) {
                    tasks.push({name, description, fee});
                    total += fee;
                }
            });

            const data = {
                project_id: parseInt(projectId),
                name: document.getElementById('contractTitle').value,
                total_amount: total,
                tasks: tasks
            };

            await fetch('/api/contracts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            hideCreateContract();
            await fetchData();
        }

        // Invoice management
        async function createInvoice() {
            const data = {
                project_id: parseInt(document.getElementById('invoiceProject').value),
                contract_id: parseInt(document.getElementById('invoiceContract').value) || null,
                amount: calculateInvoiceTotal()
            };
            await fetch('/api/invoices', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            hideCreateInvoice();
            await fetchData();
        }

        // UI helpers
        function showCreateProject() { document.getElementById('create-project').style.display = 'block'; }
        function hideCreateProject() { document.getElementById('create-project').style.display = 'none'; }
        function showCreateContract() { document.getElementById('create-contract').style.display = 'block'; }
        function hideCreateContract() { document.getElementById('create-contract').style.display = 'none'; }
        function showCreateInvoice() { document.getElementById('create-invoice').style.display = 'block'; }
        function hideCreateInvoice() { document.getElementById('create-invoice').style.display = 'none'; }

        function addContractTask() {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-input';
            taskDiv.innerHTML = `
                <input type="text" placeholder="Task Name">
                <textarea placeholder="Task Description"></textarea>
                <input type="number" placeholder="Fee" step="0.01">
                <button onclick="removeContractTask(this)">Remove</button>
            `;
            document.getElementById('contract-tasks').appendChild(taskDiv);
        }

        function removeContractTask(button) {
            button.parentElement.remove();
        }

        function updateDropdowns() {
            const projectOptions = currentData.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.querySelectorAll('#contractProject, #invoiceProject').forEach(select => select.innerHTML =
                '<option value="">Select Project</option>' + projectOptions);
        }

        function calculateInvoiceTotal() {
            // Implementation based on selected tasks
            return 0;
        }

        // Render functions
        function renderAll() {
            renderProjects();
            renderContracts();
            renderInvoices();
            renderTasks();
        }

        function renderProjects() {
            const container = document.getElementById('projects-list');
            container.innerHTML = currentData.projects.map(project => `
                <div class="project-item ${project.status}">
                    <h3>${project.name}</h3>
                    <p><strong>Client:</strong> ${project.client_name}</p>
                    <p><strong>Budget:</strong> $${project.budget || 0}</p>
                    <p><strong>Status:</strong> ${project.status}</p>
                    <button onclick="deleteItem('projects', ${project.id})">Delete</button>
                </div>
            `).join('');
        }

        function renderContracts() {
            const container = document.getElementById('contracts-list');
            container.innerHTML = currentData.contracts.map(contract => `
                <div class="project-item">
                    <h3>${contract.contract_number}</h3>
                    <p><strong>Project:</strong> ${contract.project_name}</p>
                    <p><strong>Total:</strong> $${contract.total_amount || 0}</p>
                    <p><strong>Status:</strong> ${contract.status}</p>
                    
                    <div class="tasks-section">
                        <h4>Contract Tasks</h4>
                        ${contract.tasks.map(task => `
                            <div class="task-line">
                                <span>${task.name}</span>
                                <span>$${task.fee}</span>
                            </div>
                        `).join('')}
                        <div class="total-bar">Total: $${contract.task_total || 0}</div>
                    </div>
                    
                    <button onclick="deleteItem('contracts', ${contract.id})">Delete</button>
                </div>
            `).join('');
        }

        function renderInvoices() {
            const container = document.getElementById('invoices-list');
            container.innerHTML = currentData.invoices.map(invoice => `
                <div class="project-item">
                    <h3>${invoice.invoice_number}</h3>
                    <p><strong>Amount:</strong> $${invoice.amount}</p>
                    <p><strong>Status:</strong> ${invoice.status}</p>
                    <button onclick="deleteItem('invoices', ${invoice.id})">Delete</button>
                </div>
            `).join('');
        }

        function renderTasks() {
            const container = document.getElementById('tasks-list');
            container.innerHTML = currentData.tasks.map(task => `
                <div class="task-line">
                    <span><strong>${task.name}</strong> - ${task.project_name}</span>
                    <span>$${task.fee}</span>
                    <button onclick="deleteItem('tasks', ${task.id})">Delete</button>
                </div>
            `).join('');
        }

        // Delete functionality
        async function deleteItem(type, id) {
            await fetch(`/api/${type}/${id}`, {method: 'DELETE'});
            await fetchData();
        }

        // Auto-populate selection
        document.getElementById('contractProject').addEventListener('change', async function() {
            const projectId = this.value;
            if (projectId) {
                const tasks = currentData.tasks.filter(t => t.project_id == projectId && !t.contract_id);
                // Could populate default tasks
            }
        });

        bootstrap();
        async function bootstrap() {
            // Do once
        }
    </script>
</body>
</html>