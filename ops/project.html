<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Detail - Conductor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#6c63ff',
              'primary-hover': '#5a52d5',
              'dark-bg': '#1a1a2e',
              'dark-card': '#242442',
              'dark-border': '#444',
            }
          }
        }
      }
    </script>
    <style>
        /* Minimal styles for JS-generated dynamic classes and states */
        .modal { display: none; }
        .modal.active { display: flex; }
        .hidden { display: none; }
        .expand-icon { color: #888; transition: transform 0.2s; }
        .expand-icon.expanded { transform: rotate(180deg); }

        /* Status badges */
        .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .status-proposal { background: #3b3b6d; color: #a5a5ff; }
        .status-contract { background: #3d4b3d; color: #a5d6a5; }
        .status-invoiced { background: #4b4b3d; color: #ffd700; }
        .status-paid { background: #2d4a3d; color: #4ade80; }
        .status-complete { background: #1a3a2e; color: #10b981; }

        /* Invoice status */
        .invoice-status { padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .invoice-status-unpaid { background: #3b3b6d; color: #a5a5ff; }
        .invoice-status-sent { background: #4b4b3d; color: #ffd700; }
        .invoice-status-paid { background: #2d4a3d; color: #4ade80; }

        /* JS-generated component classes */
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; text-decoration: none; border: none; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-primary { background: #6c63ff; color: white; }
        .btn-primary:hover { background: #5a52d5; }
        .btn-secondary { background: #242442; color: #ccc; border: 1px solid #444; }
        .btn-secondary:hover { background: #2d2d4a; }
        .btn-success { background: #2d4a3d; color: #4ade80; }
        .btn-success:hover { background: #3d5a4d; }
        .btn-warning { background: #4b4b3d; color: #ffd700; }
        .btn-warning:hover { background: #5b5b4d; }
        .btn-danger { background: #4a2c2c; color: #ff6b6b; }
        .btn-danger:hover { background: #5a3c3c; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }

        .info-item label { display: block; color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px; }
        .info-item span { color: #fff; }
        .info-item a { color: #6c63ff; }

        .financial-item { background: #1a1a2e; padding: 16px; border-radius: 8px; text-align: center; }
        .financial-value { font-size: 1.5rem; font-weight: 700; color: #6c63ff; }
        .financial-label { color: #888; font-size: 0.8rem; margin-top: 4px; }
        .financial-item.success .financial-value { color: #4ade80; }
        .financial-item.warning .financial-value { color: #fbbf24; }

        .list-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a2e; padding: 12px 16px; border-radius: 8px; }
        .list-item-info { display: flex; align-items: center; gap: 16px; }
        .list-item-primary { color: #fff; font-weight: 500; }
        .list-item-secondary { color: #888; font-size: 0.85rem; }
        .list-item-amount { color: #4ade80; font-weight: 600; }
        .list-item-actions { display: flex; gap: 8px; }

        .contract-card { background: #1a1a2e; border-radius: 8px; overflow: hidden; }
        .contract-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; }
        .contract-header:hover { background: #222244; }
        .contract-tasks-section { border-top: 1px solid #333; padding: 12px 16px; background: #161630; }
        .contract-task-row { display: grid; grid-template-columns: 1fr 100px 80px 60px; gap: 12px; align-items: center; padding: 8px 12px; background: #1a1a2e; border-radius: 6px; margin-bottom: 8px; }
        .contract-task-name { color: #fff; font-weight: 500; }
        .contract-task-amount { color: #4ade80; text-align: right; }
        .contract-task-billed { color: #888; font-size: 0.85rem; text-align: right; }
        .contract-task-actions { display: flex; gap: 4px; justify-content: flex-end; }
        .contract-tasks-footer { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #333; }

        .invoice-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a2e; padding: 16px; border-radius: 8px; border-left: 4px solid transparent; }
        .invoice-item.current { border-left-color: #6c63ff; background: #2a2a4a; }
        .invoice-item.paid { border-left-color: #4ade80; }
        .invoice-item.sent { border-left-color: #ffd700; }
        .invoice-number { font-weight: 600; color: #fff; }
        .invoice-details { display: flex; align-items: center; gap: 16px; }
        .invoice-amount { font-size: 1.1rem; font-weight: 600; }
        .invoice-date { color: #888; font-size: 0.85rem; }
        .chain-arrow { text-align: center; color: #444; font-size: 1.2rem; }
        .current-badge { color: #6c63ff; font-size: 0.75rem; margin-left: 8px; }
        .current-invoice-amount { font-size: 1.5rem; font-weight: 700; color: #4ade80; }
        .current-invoice-dates { color: #888; font-size: 0.85rem; }

        .invoice-task-select { padding: 12px; background: #1a1a2e; border-radius: 8px; margin-bottom: 12px; }
        .invoice-task-select-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .invoice-task-select-name { color: #fff; font-weight: 500; }
        .invoice-task-select-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 0.85rem; color: #888; }
        .invoice-task-select-input { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .invoice-task-select-input input { width: 80px; padding: 6px 8px; background: #242442; border: 1px solid #444; border-radius: 4px; color: #fff; }
        .invoice-total-row { display: flex; justify-content: space-between; padding: 16px; background: #242442; border-radius: 8px; font-size: 1.1rem; font-weight: 600; }

        /* Task status badges */
        .task-status { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .task-status-todo { background: #3b3b6d; color: #a5a5ff; }
        .task-status-in_progress { background: #4b4b3d; color: #ffd700; }
        .task-status-blocked { background: #4a2c2c; color: #ff6b6b; }
        .task-status-done { background: #2d4a3d; color: #4ade80; }
        .task-status-canceled { background: #333; color: #888; }

        .task-filter { background: #1a1a2e; color: #888; border: 1px solid #333; }
        .task-filter.active { background: #6c63ff; color: white; border-color: #6c63ff; }

        .task-card { background: #1a1a2e; border-radius: 8px; overflow: hidden; }
        .task-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; }
        .task-header:hover { background: #222244; }
        .task-detail { border-top: 1px solid #333; padding: 16px; background: #161630; }
        .task-subtask { background: #1e1e3a; border-radius: 6px; padding: 8px 12px; margin-left: 20px; margin-bottom: 6px; }

        .empty-state { color: #666; text-align: center; padding: 24px; }

        @media (max-width: 768px) {
            .contract-task-row { grid-template-columns: 1fr; gap: 4px; }
        }
    </style>
</head>
<body class="font-sans leading-relaxed text-white bg-dark-bg min-h-screen">
    <div class="max-w-[1000px] mx-auto px-5 py-10">
        <header class="flex justify-between items-center mb-8">
            <div>
                <a href="dashboard.html" class="text-primary text-sm no-underline hover:underline">&larr; Back to Dashboard</a>
                <h1 id="project-title" class="text-3xl text-white mb-2">Loading...</h1>
                <div class="text-gray-500 text-sm" id="project-meta"></div>
            </div>
            <div id="header-actions"></div>
        </header>

        <div id="loading" class="text-center py-16 text-gray-500">Loading project details...</div>
        <div id="error" class="text-center py-16 text-red-400" style="display: none;"></div>
        <div id="content" style="display: none;">

            <!-- Client Info -->
            <div class="bg-dark-card rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm text-gray-500 uppercase tracking-wider">Client</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4" id="client-info"></div>
            </div>

            <!-- Financials -->
            <div class="bg-dark-card rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm text-gray-500 uppercase tracking-wider">Financials</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="financials"></div>
            </div>

            <!-- Current Invoice -->
            <div class="bg-dark-card rounded-xl p-6 mb-6 bg-gradient-to-br from-[#2a2a4a] to-dark-card border border-primary" id="current-invoice-section" style="display: none;">
                <div class="flex justify-between items-start mb-5">
                    <div>
                        <div class="text-xl text-white font-semibold" id="current-invoice-title">Current Invoice</div>
                        <div class="text-gray-500 text-sm" id="current-invoice-subtitle"></div>
                    </div>
                    <div class="flex gap-2" id="current-invoice-actions"></div>
                </div>
                <div id="current-invoice-content"></div>
            </div>

            <!-- Tasks -->
            <div class="bg-dark-card rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm text-gray-500 uppercase tracking-wider">Tasks</span>
                    <button class="btn btn-primary btn-small" onclick="openAddTaskModal()">+ Add Task</button>
                </div>
                <div class="flex gap-2 mb-4" id="task-filters">
                    <button class="btn btn-small task-filter active" data-filter="all" onclick="setTaskFilter('all')">All</button>
                    <button class="btn btn-small task-filter" data-filter="todo" onclick="setTaskFilter('todo')">Todo</button>
                    <button class="btn btn-small task-filter" data-filter="in_progress" onclick="setTaskFilter('in_progress')">In Progress</button>
                    <button class="btn btn-small task-filter" data-filter="blocked" onclick="setTaskFilter('blocked')">Blocked</button>
                    <button class="btn btn-small task-filter" data-filter="done" onclick="setTaskFilter('done')">Done</button>
                </div>
                <div class="flex flex-col gap-2" id="tasks-list"></div>
            </div>

            <!-- Proposals -->
            <div class="bg-dark-card rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm text-gray-500 uppercase tracking-wider">Proposals</span>
                    <button class="btn btn-primary btn-small" onclick="openAddProposalModal()">+ Add Proposal</button>
                </div>
                <div class="flex flex-col gap-2" id="proposals-list"></div>
            </div>

            <!-- Contracts -->
            <div class="bg-dark-card rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm text-gray-500 uppercase tracking-wider">Contracts</span>
                    <button class="btn btn-primary btn-small" onclick="openAddContractModal()">+ Add Contract</button>
                </div>
                <div class="flex flex-col gap-2" id="contracts-list"></div>
            </div>

            <!-- Invoice History -->
            <div class="bg-dark-card rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm text-gray-500 uppercase tracking-wider">Invoice History</span>
                    <button class="btn btn-primary btn-small" onclick="createNewInvoice()">+ Create Invoice</button>
                </div>
                <div class="flex flex-col gap-3" id="invoices-list"></div>
            </div>

        </div>
    </div>

    <!-- Add Proposal Modal -->
    <div id="add-proposal-modal" class="modal fixed inset-0 bg-black/70 z-[1000] items-center justify-center">
        <div class="bg-dark-card rounded-xl p-8 max-w-[600px] w-[90%] max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-white text-xl">Add Proposal</h3>
                <button class="bg-transparent border-none text-gray-500 text-2xl cursor-pointer" onclick="closeModal('add-proposal-modal')">&times;</button>
            </div>
            <form id="add-proposal-form" onsubmit="saveProposal(event)">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-400 mb-1.5 text-sm">Engineer</label>
                        <select id="proposal-engineer" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary">
                            <option value="tim">Tim Grote</option>
                            <option value="ally">Ally Liebow</option>
                            <option value="matara">Matara Liebow</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1.5 text-sm">Contact Method</label>
                        <input type="text" id="proposal-contact-method" placeholder="e.g., site meeting" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Status</label>
                    <select id="proposal-status" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary">
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <!-- Proposal Tasks -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-gray-400 text-sm">Tasks</label>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addProposalTaskRow()">+ Add Task</button>
                    </div>
                    <div id="proposal-tasks-container"></div>
                    <div class="mt-2 text-right text-sm text-gray-400">
                        Total: <span id="proposal-tasks-total" class="text-green-400 font-semibold">$0</span>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="flex items-center gap-2 text-gray-400 text-sm cursor-pointer">
                        <input type="checkbox" id="proposal-generate-doc" checked class="accent-primary">
                        Generate Google Doc
                    </label>
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-[#333]">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-proposal-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Proposal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Contract Modal -->
    <div id="add-contract-modal" class="modal fixed inset-0 bg-black/70 z-[1000] items-center justify-center">
        <div class="bg-dark-card rounded-xl p-8 max-w-[500px] w-[90%] max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-white text-xl">Add Contract</h3>
                <button class="bg-transparent border-none text-gray-500 text-2xl cursor-pointer" onclick="closeModal('add-contract-modal')">&times;</button>
            </div>
            <form id="add-contract-form" onsubmit="saveContract(event)">
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Total Amount</label>
                    <input type="number" id="contract-amount" step="0.01" min="0" required class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Signed Date</label>
                    <input type="date" id="contract-signed-date" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">File Path (optional)</label>
                    <input type="text" id="contract-file-path" placeholder="/dropbox/path/to/contract.pdf" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-[#333]">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-contract-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Contract</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contract Task Modal -->
    <div id="contract-task-modal" class="modal fixed inset-0 bg-black/70 z-[1000] items-center justify-center">
        <div class="bg-dark-card rounded-xl p-8 max-w-[500px] w-[90%] max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="contract-task-modal-title" class="text-white text-xl">Add Task</h3>
                <button class="bg-transparent border-none text-gray-500 text-2xl cursor-pointer" onclick="closeModal('contract-task-modal')">&times;</button>
            </div>
            <form id="contract-task-form" onsubmit="saveContractTask(event)">
                <input type="hidden" id="ct-contract-id">
                <input type="hidden" id="ct-task-id">
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Task Name</label>
                    <input type="text" id="ct-name" required placeholder="e.g., Preliminary Design" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Description</label>
                    <textarea id="ct-description" rows="2" placeholder="Optional description" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Amount ($)</label>
                    <input type="number" id="ct-amount" step="0.01" min="0" required class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary">
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-[#333]">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('contract-task-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Invoice from Contract Modal -->
    <div id="create-contract-invoice-modal" class="modal fixed inset-0 bg-black/70 z-[1000] items-center justify-center">
        <div class="bg-dark-card rounded-xl p-8 max-w-[600px] w-[90%] max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="contract-invoice-title" class="text-white text-xl">Create Invoice from Contract</h3>
                <button class="bg-transparent border-none text-gray-500 text-2xl cursor-pointer" onclick="closeModal('create-contract-invoice-modal')">&times;</button>
            </div>
            <div id="contract-invoice-content">
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Select tasks to invoice and enter percent to bill this invoice:</label>
                </div>
                <div id="contract-invoice-tasks-list"></div>
                <div class="invoice-total-row">
                    <span>Invoice Total:</span>
                    <span id="contract-invoice-total">$0</span>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-[#333]">
                <button type="button" class="btn btn-secondary" onclick="closeModal('create-contract-invoice-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitContractInvoice()">Create Invoice</button>
            </div>
        </div>
    </div>

    <!-- Edit Invoice Links Modal -->
    <div id="edit-invoice-links-modal" class="modal fixed inset-0 bg-black/70 z-[1000] items-center justify-center">
        <div class="bg-dark-card rounded-xl p-8 max-w-[500px] w-[90%] max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-white text-xl">Edit Invoice Links</h3>
                <button class="bg-transparent border-none text-gray-500 text-2xl cursor-pointer" onclick="closeModal('edit-invoice-links-modal')">&times;</button>
            </div>
            <form id="edit-invoice-links-form" onsubmit="saveInvoiceLinks(event)">
                <input type="hidden" id="edit-links-invoice-id">
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Data Path (Sheet URL)</label>
                    <input type="text" id="edit-links-data-path" placeholder="https://docs.google.com/spreadsheets/d/..." class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">PDF Path</label>
                    <input type="text" id="edit-links-pdf-path" placeholder="/uploads/invoices/PROJ-1.pdf" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-[#333]">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-invoice-links-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="modal fixed inset-0 bg-black/70 z-[1000] items-center justify-center">
        <div class="bg-dark-card rounded-xl p-8 max-w-[600px] w-[90%] max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="task-modal-title" class="text-white text-xl">Add Task</h3>
                <button class="bg-transparent border-none text-gray-500 text-2xl cursor-pointer" onclick="closeModal('task-modal')">&times;</button>
            </div>
            <form id="task-form" onsubmit="saveTask(event)">
                <input type="hidden" id="task-edit-id">
                <input type="hidden" id="task-parent-id">
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Title *</label>
                    <input type="text" id="task-title" required placeholder="Task title" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Description</label>
                    <textarea id="task-description" rows="3" placeholder="Optional description" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-400 mb-1.5 text-sm">Status</label>
                        <select id="task-status" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary">
                            <option value="todo">Todo</option>
                            <option value="in_progress">In Progress</option>
                            <option value="blocked">Blocked</option>
                            <option value="done">Done</option>
                            <option value="canceled">Canceled</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1.5 text-sm">Start Date</label>
                        <input type="date" id="task-start-date" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1.5 text-sm">Due Date</label>
                        <input type="date" id="task-due-date" class="w-full p-2.5 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-400 mb-1.5 text-sm">Assignees</label>
                    <div id="task-assignees-checkboxes" class="flex flex-wrap gap-3"></div>
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-[#333]">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('task-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        let project = null;
        let jobId = null;
        let expandContractAfterRender = null;  // Contract ID to expand after next render

        // Get job_id from URL
        function getJobIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('job') || params.get('job_id');
        }

        async function loadProject() {
            jobId = getJobIdFromUrl();
            if (!jobId) {
                showError('No project ID specified.');
                return;
            }

            try {
                const response = await fetch(API_BASE + '/projects/' + encodeURIComponent(jobId));
                if (!response.ok) {
                    showError('Project not found');
                    return;
                }
                const data = await response.json();

                // Map API response to frontend field names
                project = {
                    ...data,
                    job_id: data.job_id,
                    project_name: data.project_name,
                    client_name: data.client_name || '',
                    client_email: data.client_email || '',
                };
                renderProject();
            } catch (error) {
                console.error('Failed to load project:', error);
                showError('Failed to load project.');
            }
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            // Add back link safely
            const link = document.createElement('a');
            link.href = 'dashboard.html';
            link.textContent = ' Back to dashboard';
            errorDiv.appendChild(link);
            errorDiv.style.display = 'block';
        }

        function renderProject() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Title
            const titleEl = document.getElementById('project-title');
            titleEl.textContent = '';
            titleEl.appendChild(document.createTextNode(project.project_name + ' '));
            const statusSpan = document.createElement('span');
            statusSpan.className = 'status status-' + project.status;
            statusSpan.textContent = formatStatus(project.status);
            titleEl.appendChild(statusSpan);

            document.getElementById('project-meta').textContent = 'Job ID: ' + project.job_id;
            document.title = project.project_name + ' - Conductor';

            // Header actions
            const headerActions = document.getElementById('header-actions');
            headerActions.textContent = '';
            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'btn btn-secondary';
            refreshBtn.textContent = 'Refresh';
            refreshBtn.onclick = function() { location.reload(); };
            headerActions.appendChild(refreshBtn);

            // Render sections
            renderClientInfo();
            renderFinancials();
            renderCurrentInvoice();
            renderTasks();
            renderProposals();
            renderContracts();
            renderInvoices();
        }

        function renderClientInfo() {
            const container = document.getElementById('client-info');
            container.textContent = '';

            const fields = [
                { label: 'Name', value: project.client_name },
                { label: 'Company', value: project.client_company },
                { label: 'Email', value: project.client_email, isEmail: true },
                { label: 'Phone', value: project.client_phone }
            ];

            fields.forEach(function(field) {
                const item = document.createElement('div');
                item.className = 'info-item';

                const label = document.createElement('label');
                label.textContent = field.label;
                item.appendChild(label);

                const span = document.createElement('span');
                if (field.isEmail && field.value) {
                    const link = document.createElement('a');
                    link.href = 'mailto:' + field.value;
                    link.textContent = field.value;
                    span.appendChild(link);
                } else {
                    span.textContent = field.value || '-';
                }
                item.appendChild(span);

                container.appendChild(item);
            });
        }

        function renderFinancials() {
            const contracts = project.contracts || [];
            const invoices = project.invoices || [];

            const totalContracted = contracts.reduce(function(sum, c) { return sum + (c.total_amount || 0); }, 0);
            const totalInvoiced = invoices.reduce(function(sum, i) { return sum + (i.total_due || 0); }, 0);
            const totalPaid = invoices
                .filter(function(i) { return i.paid_status === 'paid'; })
                .reduce(function(sum, i) { return sum + (i.total_due || 0); }, 0);
            const outstanding = totalInvoiced - totalPaid;

            const container = document.getElementById('financials');
            container.textContent = '';

            const items = [
                { value: totalContracted, label: 'Contracted', class: '' },
                { value: totalInvoiced, label: 'Invoiced', class: '' },
                { value: totalPaid, label: 'Paid', class: 'success' },
                { value: outstanding, label: 'Outstanding', class: outstanding > 0 ? 'warning' : '' }
            ];

            items.forEach(function(item) {
                const div = document.createElement('div');
                div.className = 'financial-item' + (item.class ? ' ' + item.class : '');

                const valueDiv = document.createElement('div');
                valueDiv.className = 'financial-value';
                valueDiv.textContent = '$' + item.value.toLocaleString();
                div.appendChild(valueDiv);

                const labelDiv = document.createElement('div');
                labelDiv.className = 'financial-label';
                labelDiv.textContent = item.label;
                div.appendChild(labelDiv);

                container.appendChild(div);
            });
        }

        function renderCurrentInvoice() {
            const section = document.getElementById('current-invoice-section');
            const invoices = project.invoices || [];

            // Find current invoice
            var currentInvoice = null;
            if (project.current_invoice_id) {
                currentInvoice = invoices.find(function(i) { return i.id === project.current_invoice_id; });
            }
            if (!currentInvoice) {
                currentInvoice = invoices.find(function(i) { return i.paid_status !== 'paid'; });
            }

            if (!currentInvoice) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            document.getElementById('current-invoice-title').textContent =
                'Current Invoice: ' + currentInvoice.invoice_number;
            document.getElementById('current-invoice-subtitle').textContent =
                'Status: ' + currentInvoice.sent_status + ' / ' + currentInvoice.paid_status;

            // Actions
            const actionsDiv = document.getElementById('current-invoice-actions');
            actionsDiv.textContent = '';

            const hasSheet = currentInvoice.data_path && currentInvoice.data_path.includes('google.com');
            const hasPdf = !!currentInvoice.pdf_path;

            // Open Sheet — when data_path is a Google Sheet URL
            if (hasSheet) {
                const sheetBtn = document.createElement('a');
                sheetBtn.href = currentInvoice.data_path;
                sheetBtn.target = '_blank';
                sheetBtn.className = 'btn btn-secondary btn-small';
                sheetBtn.textContent = 'Open Sheet';
                actionsDiv.appendChild(sheetBtn);
            }

            // Finalize — unsent + has sheet (not yet finalized)
            if (currentInvoice.sent_status === 'unsent' && hasSheet) {
                const finalizeBtn = document.createElement('button');
                finalizeBtn.className = 'btn btn-primary btn-small';
                finalizeBtn.textContent = 'Finalize';
                finalizeBtn.onclick = function() { finalizeInvoice(currentInvoice.id); };
                actionsDiv.appendChild(finalizeBtn);
            }

            // View PDF — when pdf exists
            if (hasPdf) {
                const pdfBtn = document.createElement('a');
                pdfBtn.href = currentInvoice.pdf_path;
                pdfBtn.target = '_blank';
                pdfBtn.className = 'btn btn-secondary btn-small';
                pdfBtn.textContent = 'View PDF';
                actionsDiv.appendChild(pdfBtn);
            }

            // Send Invoice — has PDF + unsent
            if (hasPdf && currentInvoice.sent_status === 'unsent') {
                const sendBtn = document.createElement('button');
                sendBtn.className = 'btn btn-warning btn-small';
                sendBtn.textContent = 'Send Invoice';
                sendBtn.onclick = function() { sendInvoice(currentInvoice.id); };
                actionsDiv.appendChild(sendBtn);
            }

            // Mark Paid — sent + not paid
            if (currentInvoice.sent_status === 'sent' && currentInvoice.paid_status !== 'paid') {
                const paidBtn = document.createElement('button');
                paidBtn.className = 'btn btn-success btn-small';
                paidBtn.textContent = 'Mark Paid';
                paidBtn.onclick = function() { markPaid(currentInvoice.id); };
                actionsDiv.appendChild(paidBtn);
            }

            // Create Next — sent (don't need to wait for paid)
            if (currentInvoice.sent_status === 'sent') {
                const processBtn = document.createElement('button');
                processBtn.className = 'btn btn-primary btn-small';
                processBtn.textContent = 'Create Next';
                processBtn.onclick = function() { processInvoice(currentInvoice.id); };
                actionsDiv.appendChild(processBtn);
            }

            // Edit Links — always available
            const editLinksBtn = document.createElement('button');
            editLinksBtn.className = 'btn btn-secondary btn-small';
            editLinksBtn.textContent = 'Edit Links';
            editLinksBtn.onclick = function() { openEditInvoiceLinks(currentInvoice.id); };
            actionsDiv.appendChild(editLinksBtn);

            // Content
            const contentDiv = document.getElementById('current-invoice-content');
            contentDiv.textContent = '';

            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';

            const amountDiv = document.createElement('div');
            const amountValue = document.createElement('div');
            amountValue.className = 'current-invoice-amount';
            amountValue.textContent = '$' + (currentInvoice.total_due || 0).toLocaleString();
            amountDiv.appendChild(amountValue);

            const datesDiv = document.createElement('div');
            datesDiv.className = 'current-invoice-dates';
            var dateText = currentInvoice.sent_at ? 'Sent: ' + formatDate(currentInvoice.sent_at) : 'Not sent yet';
            if (currentInvoice.paid_at) {
                dateText += ' | Paid: ' + formatDate(currentInvoice.paid_at);
            }
            datesDiv.textContent = dateText;
            amountDiv.appendChild(datesDiv);

            wrapper.appendChild(amountDiv);
            contentDiv.appendChild(wrapper);
        }

        function renderProposals() {
            const container = document.getElementById('proposals-list');
            const proposals = project.proposals || [];

            container.textContent = '';

            if (proposals.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = 'No proposals yet';
                container.appendChild(empty);
                return;
            }

            proposals.forEach(function(p) {
                const item = document.createElement('div');
                item.className = 'list-item';

                const info = document.createElement('div');
                info.className = 'list-item-info';

                const primary = document.createElement('span');
                primary.className = 'list-item-primary';
                primary.textContent = p.id;
                info.appendChild(primary);

                const secondary = document.createElement('span');
                secondary.className = 'list-item-secondary';
                var secondaryText = p.status + ' | ' + formatDate(p.created_at);
                if (p.engineer_name) secondaryText += ' | ' + p.engineer_name;
                secondary.textContent = secondaryText;
                info.appendChild(secondary);

                item.appendChild(info);

                const right = document.createElement('div');
                right.style.cssText = 'display: flex; align-items: center; gap: 16px;';

                const amount = document.createElement('span');
                amount.className = 'list-item-amount';
                amount.textContent = '$' + (p.total_fee || 0).toLocaleString();
                right.appendChild(amount);

                const actions = document.createElement('div');
                actions.className = 'list-item-actions';

                var hasDoc = p.data_path && p.data_path.includes('google.com');
                var hasPdf = !!p.pdf_path;

                if (!hasDoc) {
                    var genDocBtn = document.createElement('button');
                    genDocBtn.className = 'btn btn-primary btn-small';
                    genDocBtn.textContent = 'Gen Doc';
                    genDocBtn.onclick = (function(id) { return function() { generateProposalDoc(id); }; })(p.id);
                    actions.appendChild(genDocBtn);
                }

                if (hasDoc) {
                    var openDocBtn = document.createElement('a');
                    openDocBtn.href = p.data_path;
                    openDocBtn.target = '_blank';
                    openDocBtn.className = 'btn btn-secondary btn-small';
                    openDocBtn.textContent = 'Open Doc';
                    actions.appendChild(openDocBtn);
                }

                if (hasDoc && !hasPdf) {
                    var pdfBtn = document.createElement('button');
                    pdfBtn.className = 'btn btn-secondary btn-small';
                    pdfBtn.textContent = 'PDF';
                    pdfBtn.onclick = (function(id) { return function() { exportProposalPdf(id); }; })(p.id);
                    actions.appendChild(pdfBtn);
                }

                if (hasPdf) {
                    var viewPdfBtn = document.createElement('a');
                    viewPdfBtn.href = p.pdf_path;
                    viewPdfBtn.target = '_blank';
                    viewPdfBtn.className = 'btn btn-secondary btn-small';
                    viewPdfBtn.textContent = 'View PDF';
                    actions.appendChild(viewPdfBtn);
                }

                if (hasDoc && p.status !== 'sent' && p.status !== 'accepted') {
                    var sendBtn = document.createElement('button');
                    sendBtn.className = 'btn btn-warning btn-small';
                    sendBtn.textContent = 'Send';
                    sendBtn.onclick = (function(id) { return function() { sendProposal(id); }; })(p.id);
                    actions.appendChild(sendBtn);
                }

                if (p.status === 'accepted') {
                    var convertBtn = document.createElement('button');
                    convertBtn.className = 'btn btn-success btn-small';
                    convertBtn.textContent = 'Convert to Contract';
                    convertBtn.onclick = (function(id) { return function() { convertToContract(id); }; })(p.id);
                    actions.appendChild(convertBtn);
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-small';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = (function(id) { return function() { deleteProposal(id); }; })(p.id);
                actions.appendChild(deleteBtn);

                right.appendChild(actions);
                item.appendChild(right);
                container.appendChild(item);
            });
        }

        function renderContracts() {
            const container = document.getElementById('contracts-list');
            const contracts = project.contracts || [];

            // Remember which sections were expanded before re-render
            const expandedSections = new Set();
            contracts.forEach(function(c) {
                const section = document.getElementById('tasks-section-' + c.id);
                if (section && !section.classList.contains('hidden')) {
                    expandedSections.add(c.id);
                }
            });

            container.textContent = '';

            if (contracts.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = 'No contracts yet';
                container.appendChild(empty);
                return;
            }

            contracts.forEach(function(c) {
                const card = document.createElement('div');
                card.className = 'contract-card';

                // Header row (clickable to expand)
                const header = document.createElement('div');
                header.className = 'contract-header';

                const info = document.createElement('div');
                info.className = 'list-item-info';

                const primary = document.createElement('span');
                primary.className = 'list-item-primary';
                primary.textContent = c.id;
                info.appendChild(primary);

                const secondary = document.createElement('span');
                secondary.className = 'list-item-secondary';
                const taskCount = (c.tasks || []).length;
                secondary.textContent = 'Signed: ' + (c.signed_at ? formatDate(c.signed_at) : 'Not signed') +
                    ' | ' + taskCount + ' task' + (taskCount !== 1 ? 's' : '');
                info.appendChild(secondary);

                header.appendChild(info);

                const right = document.createElement('div');
                right.style.cssText = 'display: flex; align-items: center; gap: 16px;';

                const amount = document.createElement('span');
                amount.className = 'list-item-amount';
                amount.textContent = '$' + (c.total_amount || 0).toLocaleString();
                right.appendChild(amount);

                const expandIcon = document.createElement('span');
                expandIcon.className = 'expand-icon';
                expandIcon.textContent = '\u25BC';
                expandIcon.id = 'expand-icon-' + c.id;
                right.appendChild(expandIcon);

                header.appendChild(right);
                card.appendChild(header);

                // Tasks section (expandable)
                const tasksSection = document.createElement('div');
                tasksSection.className = 'contract-tasks-section hidden';
                tasksSection.id = 'tasks-section-' + c.id;

                // Render tasks
                const tasks = c.tasks || [];
                tasks.forEach(function(task) {
                    const taskRow = document.createElement('div');
                    taskRow.className = 'contract-task-row';

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'contract-task-name';
                    nameDiv.textContent = task.name;
                    if (task.description) {
                        nameDiv.title = task.description;
                    }
                    taskRow.appendChild(nameDiv);

                    const amountDiv = document.createElement('div');
                    amountDiv.className = 'contract-task-amount';
                    amountDiv.textContent = '$' + (task.amount || 0).toLocaleString();
                    taskRow.appendChild(amountDiv);

                    const billedDiv = document.createElement('div');
                    billedDiv.className = 'contract-task-billed';
                    billedDiv.textContent = Number(task.billed_percent || 0).toFixed(0) + '% billed';
                    taskRow.appendChild(billedDiv);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'contract-task-actions';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-secondary btn-small';
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = function(e) {
                        e.stopPropagation();
                        editContractTask(c.id, task);
                    };
                    actionsDiv.appendChild(editBtn);

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-danger btn-small';
                    delBtn.textContent = '\u00d7';
                    delBtn.onclick = function(e) {
                        e.stopPropagation();
                        deleteContractTask(c.id, task.id);
                    };
                    actionsDiv.appendChild(delBtn);

                    taskRow.appendChild(actionsDiv);
                    tasksSection.appendChild(taskRow);
                });

                // Footer with action buttons
                const footer = document.createElement('div');
                footer.className = 'contract-tasks-footer';

                const addTaskBtn = document.createElement('button');
                addTaskBtn.className = 'btn btn-secondary btn-small';
                addTaskBtn.textContent = '+ Add Task';
                addTaskBtn.onclick = function(e) {
                    e.stopPropagation();
                    openAddContractTaskModal(c.id);
                };
                footer.appendChild(addTaskBtn);

                if (tasks.length > 0) {
                    const createInvBtn = document.createElement('button');
                    createInvBtn.className = 'btn btn-primary btn-small';
                    createInvBtn.textContent = 'Create Invoice';
                    createInvBtn.onclick = function(e) {
                        e.stopPropagation();
                        createInvoiceFromContract(c.id);
                    };
                    footer.appendChild(createInvBtn);
                }

                if (c.file_path) {
                    const viewLink = document.createElement('a');
                    viewLink.href = c.file_path;
                    viewLink.target = '_blank';
                    viewLink.className = 'btn btn-secondary btn-small';
                    viewLink.textContent = 'View PDF';
                    viewLink.onclick = function(e) { e.stopPropagation(); };
                    footer.appendChild(viewLink);
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-small';
                deleteBtn.textContent = 'Delete Contract';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    deleteContract(c.id);
                };
                footer.appendChild(deleteBtn);

                tasksSection.appendChild(footer);
                card.appendChild(tasksSection);

                // Click header to expand/collapse
                header.onclick = function() {
                    toggleContractTasks(c.id);
                };

                container.appendChild(card);

                // Restore expanded state if it was expanded before, or if we just edited this contract
                if (expandedSections.has(c.id) || expandContractAfterRender === c.id) {
                    tasksSection.classList.remove('hidden');
                    expandIcon.classList.add('expanded');
                }
            });

            // Clear the expand-after-render flag
            expandContractAfterRender = null;
        }

        function toggleContractTasks(contractId) {
            const section = document.getElementById('tasks-section-' + contractId);
            const icon = document.getElementById('expand-icon-' + contractId);
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.classList.add('expanded');
            } else {
                section.classList.add('hidden');
                icon.classList.remove('expanded');
            }
        }

        function renderInvoices() {
            const container = document.getElementById('invoices-list');
            const invoices = project.invoices || [];

            container.textContent = '';

            if (invoices.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = 'No invoices yet';
                container.appendChild(empty);
                return;
            }

            // Sort newest first
            const sorted = invoices.slice().sort(function(a, b) {
                return new Date(b.created_at) - new Date(a.created_at);
            });

            sorted.forEach(function(inv, idx) {
                const isCurrent = project.current_invoice_id === inv.id;
                const statusClass = inv.paid_status === 'paid' ? 'paid' :
                                   inv.sent_status === 'sent' ? 'sent' : '';

                const item = document.createElement('div');
                item.className = 'invoice-item' + (isCurrent ? ' current' : '') + (statusClass ? ' ' + statusClass : '');

                // Left side
                const left = document.createElement('div');

                const numSpan = document.createElement('span');
                numSpan.className = 'invoice-number';
                numSpan.textContent = inv.invoice_number;
                left.appendChild(numSpan);

                if (isCurrent) {
                    const badge = document.createElement('span');
                    badge.className = 'current-badge';
                    badge.textContent = '(Current)';
                    left.appendChild(badge);
                }

                const dateDiv = document.createElement('div');
                dateDiv.className = 'invoice-date';
                dateDiv.textContent = 'Created: ' + formatDate(inv.created_at);
                left.appendChild(dateDiv);

                item.appendChild(left);

                // Right side
                const details = document.createElement('div');
                details.className = 'invoice-details';

                const amountSpan = document.createElement('span');
                amountSpan.className = 'invoice-amount';
                amountSpan.style.color = inv.paid_status === 'paid' ? '#4ade80' : '#fff';
                amountSpan.textContent = '$' + (inv.total_due || 0).toLocaleString();
                details.appendChild(amountSpan);

                const statusSpan = document.createElement('span');
                statusSpan.className = 'invoice-status invoice-status-' + inv.paid_status;
                statusSpan.textContent = inv.paid_status;
                details.appendChild(statusSpan);

                const actions = document.createElement('div');
                actions.className = 'list-item-actions';

                // Prefer PDF for sent/paid invoices
                if (inv.pdf_path) {
                    const pdfLink = document.createElement('a');
                    pdfLink.href = inv.pdf_path;
                    pdfLink.target = '_blank';
                    pdfLink.className = 'btn btn-secondary btn-small';
                    pdfLink.textContent = 'View PDF';
                    actions.appendChild(pdfLink);
                }
                if (inv.data_path && inv.data_path.includes('google.com')) {
                    const sheetLink = document.createElement('a');
                    sheetLink.href = inv.data_path;
                    sheetLink.target = '_blank';
                    sheetLink.className = 'btn btn-secondary btn-small';
                    sheetLink.textContent = 'Open Sheet';
                    actions.appendChild(sheetLink);
                }

                details.appendChild(actions);
                item.appendChild(details);
                container.appendChild(item);

                // Chain arrow
                if (idx < sorted.length - 1 && inv.previous_invoice_id) {
                    const arrow = document.createElement('div');
                    arrow.className = 'chain-arrow';
                    arrow.textContent = '\u2193';
                    container.appendChild(arrow);
                }
            });
        }

        // Utility functions
        function formatStatus(status) {
            const labels = {
                'proposal': 'Proposal',
                'contract': 'Contract',
                'invoiced': 'Invoiced',
                'paid': 'Paid',
                'complete': 'Complete'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Modal functions
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function openAddProposalModal() {
            document.getElementById('add-proposal-form').reset();
            document.getElementById('proposal-tasks-container').textContent = '';
            addProposalTaskRow();
            updateProposalTasksTotal();
            document.getElementById('add-proposal-modal').classList.add('active');
        }

        function addProposalTaskRow() {
            var container = document.getElementById('proposal-tasks-container');
            var row = document.createElement('div');
            row.className = 'flex gap-2 mb-2 items-start';

            var nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Task name';
            nameInput.className = 'flex-1 p-2 bg-dark-bg border border-dark-border rounded-md text-white text-sm proposal-task-name';
            row.appendChild(nameInput);

            var amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.placeholder = 'Amount';
            amountInput.step = '0.01';
            amountInput.min = '0';
            amountInput.className = 'w-28 p-2 bg-dark-bg border border-dark-border rounded-md text-white text-sm proposal-task-amount';
            amountInput.oninput = updateProposalTasksTotal;
            row.appendChild(amountInput);

            var removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-small';
            removeBtn.textContent = '\u00d7';
            removeBtn.onclick = function() { row.remove(); updateProposalTasksTotal(); };
            row.appendChild(removeBtn);

            container.appendChild(row);
        }

        function updateProposalTasksTotal() {
            var total = 0;
            document.querySelectorAll('.proposal-task-amount').forEach(function(input) {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('proposal-tasks-total').textContent = '$' + total.toLocaleString();
        }

        function getProposalTasks() {
            var tasks = [];
            var rows = document.querySelectorAll('#proposal-tasks-container > div');
            rows.forEach(function(row) {
                var name = row.querySelector('.proposal-task-name').value.trim();
                var amount = parseFloat(row.querySelector('.proposal-task-amount').value) || 0;
                if (name) {
                    tasks.push({ name: name, amount: amount });
                }
            });
            return tasks;
        }

        function openAddContractModal() {
            document.getElementById('add-contract-form').reset();
            document.getElementById('contract-signed-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-contract-modal').classList.add('active');
        }

        // Close modals on backdrop click
        document.querySelectorAll('.modal').forEach(function(modal) {
            modal.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    modal.classList.remove('active');
                }
            });
        });

        async function saveProposal(event) {
            event.preventDefault();
            var tasks = getProposalTasks();
            if (tasks.length === 0) {
                alert('Add at least one task');
                return;
            }
            var body = {
                project_id: jobId,
                engineer_key: document.getElementById('proposal-engineer').value,
                contact_method: document.getElementById('proposal-contact-method').value || null,
                status: document.getElementById('proposal-status').value,
                tasks: tasks
            };
            try {
                var response = await fetch(API_BASE + '/proposals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                var data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to create proposal'));
                    return;
                }
                closeModal('add-proposal-modal');
                loadProject();
            } catch (error) {
                console.error('Failed to save proposal:', error);
                alert('Failed to save proposal');
            }
        }

        async function saveContract(event) {
            event.preventDefault();
            var body = {
                project_id: jobId,
                total_amount: parseFloat(document.getElementById('contract-amount').value) || 0,
                signed_at: document.getElementById('contract-signed-date').value || null,
                file_path: document.getElementById('contract-file-path').value || null
            };
            try {
                var response = await fetch(API_BASE + '/contracts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                var data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to create contract'));
                    return;
                }
                closeModal('add-contract-modal');
                loadProject();
            } catch (error) {
                console.error('Failed to save contract:', error);
                alert('Failed to save contract');
            }
        }

        async function deleteProposal(id) {
            if (!confirm('Delete this proposal?')) return;
            try {
                var response = await fetch(API_BASE + '/proposals/' + id, { method: 'DELETE' });
                var data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to delete proposal'));
                    return;
                }
                loadProject();
            } catch (error) {
                console.error('Failed to delete proposal:', error);
                alert('Failed to delete proposal');
            }
        }

        async function deleteContract(id) {
            if (!confirm('Delete this contract?')) return;
            try {
                var response = await fetch(API_BASE + '/contracts/' + id, { method: 'DELETE' });
                var data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to delete contract'));
                    return;
                }
                loadProject();
            } catch (error) {
                console.error('Failed to delete contract:', error);
                alert('Failed to delete contract');
            }
        }

        async function convertToContract(proposalId) {
            if (!confirm('Promote this proposal to a contract?')) return;
            try {
                var response = await fetch(API_BASE + '/proposals/' + proposalId + '/promote', { method: 'POST' });
                var data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to promote'));
                    return;
                }
                loadProject();
            } catch (error) {
                console.error('Failed to convert to contract:', error);
                alert('Failed to convert to contract');
            }
        }

        async function generateProposalDoc(proposalId) {
            try {
                var response = await fetch(API_BASE + '/proposals/' + proposalId + '/generate-doc', { method: 'POST' });
                var data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to generate doc'));
                    return;
                }
                if (data.data_path) {
                    window.open(data.data_path, '_blank');
                }
                loadProject();
            } catch (error) {
                console.error('Failed to generate doc:', error);
                alert('Failed to generate doc');
            }
        }

        async function exportProposalPdf(proposalId) {
            try {
                var response = await fetch(API_BASE + '/proposals/' + proposalId + '/export-pdf', { method: 'POST' });
                var data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to export PDF'));
                    return;
                }
                if (data.pdf_path) {
                    window.open(data.pdf_path, '_blank');
                }
                loadProject();
            } catch (error) {
                console.error('Failed to export PDF:', error);
                alert('Failed to export PDF');
            }
        }

        async function sendProposal(proposalId) {
            if (!confirm('Send this proposal to the client?')) return;
            try {
                var response = await fetch(API_BASE + '/proposals/' + proposalId + '/send', { method: 'POST' });
                var data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to send proposal'));
                    return;
                }
                alert('Proposal sent to: ' + (data.sent_to || []).join(', '));
                loadProject();
            } catch (error) {
                console.error('Failed to send proposal:', error);
                alert('Failed to send proposal');
            }
        }

        // --- Contract Tasks ---

        let currentContractForInvoice = null;

        function openAddContractTaskModal(contractId) {
            document.getElementById('contract-task-modal-title').textContent = 'Add Task';
            document.getElementById('ct-contract-id').value = contractId;
            document.getElementById('ct-task-id').value = '';
            document.getElementById('ct-name').value = '';
            document.getElementById('ct-description').value = '';
            document.getElementById('ct-amount').value = '';
            openModal('contract-task-modal');
        }

        function editContractTask(contractId, task) {
            document.getElementById('contract-task-modal-title').textContent = 'Edit Task';
            document.getElementById('ct-contract-id').value = contractId;
            document.getElementById('ct-task-id').value = task.id;
            document.getElementById('ct-name').value = task.name || '';
            document.getElementById('ct-description').value = task.description || '';
            document.getElementById('ct-amount').value = task.amount || '';
            openModal('contract-task-modal');
        }

        async function saveContractTask(event) {
            event.preventDefault();
            const contractId = document.getElementById('ct-contract-id').value;
            const taskId = document.getElementById('ct-task-id').value;
            const name = document.getElementById('ct-name').value;
            const description = document.getElementById('ct-description').value;
            const amount = parseFloat(document.getElementById('ct-amount').value) || 0;

            let url, method;
            if (taskId) {
                url = API_BASE + '/contracts/' + contractId + '/tasks/' + taskId;
                method = 'PATCH';
            } else {
                url = API_BASE + '/contracts/' + contractId + '/tasks';
                method = 'POST';
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, amount })
                });
                const data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to save task'));
                    return;
                }
                closeModal('contract-task-modal');
                expandContractAfterRender = contractId;  // Auto-expand after refresh
                loadProject();
            } catch (error) {
                console.error('Failed to save task:', error);
                alert('Failed to save task');
            }
        }

        async function deleteContractTask(contractId, taskId) {
            if (!confirm('Delete this task?')) return;

            try {
                const response = await fetch(API_BASE + '/contracts/' + contractId + '/tasks/' + taskId, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to delete task'));
                    return;
                }
                loadProject(); // Refresh
            } catch (error) {
                console.error('Failed to delete task:', error);
                alert('Failed to delete task');
            }
        }

        function createInvoiceFromContract(contractId) {
            // Find the contract
            const contract = (project.contracts || []).find(function(c) { return c.id === contractId; });
            if (!contract) {
                alert('Contract not found');
                return;
            }

            const tasks = contract.tasks || [];
            if (tasks.length === 0) {
                alert('This contract has no tasks. Add tasks first.');
                return;
            }

            currentContractForInvoice = contract;

            // Populate the modal
            document.getElementById('contract-invoice-title').textContent =
                'Create Invoice from ' + contract.id;

            const listContainer = document.getElementById('contract-invoice-tasks-list');
            listContainer.textContent = '';

            tasks.forEach(function(task) {
                const billedPct = Number(task.billed_percent || 0);
                const remaining = 100 - billedPct;
                const remainingAmount = Number(task.amount || 0) * remaining / 100;

                const taskEl = document.createElement('div');
                taskEl.className = 'invoice-task-select';

                // Header
                const header = document.createElement('div');
                header.className = 'invoice-task-select-header';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'invoice-task-select-name';
                nameSpan.textContent = task.name;
                header.appendChild(nameSpan);
                const amountSpan = document.createElement('span');
                amountSpan.textContent = '$' + (task.amount || 0).toLocaleString();
                header.appendChild(amountSpan);
                taskEl.appendChild(header);

                // Details
                const details = document.createElement('div');
                details.className = 'invoice-task-select-details';
                const billedDiv = document.createElement('div');
                billedDiv.textContent = 'Billed: ' + billedPct.toFixed(0) + '%';
                details.appendChild(billedDiv);
                const remainingDiv = document.createElement('div');
                remainingDiv.textContent = 'Remaining: ' + remaining.toFixed(0) + '%';
                details.appendChild(remainingDiv);
                const remainingAmtDiv = document.createElement('div');
                remainingAmtDiv.textContent = '$' + remainingAmount.toLocaleString() + ' left';
                details.appendChild(remainingAmtDiv);
                taskEl.appendChild(details);

                // Input
                const inputDiv = document.createElement('div');
                inputDiv.className = 'invoice-task-select-input';
                const label = document.createElement('label');
                label.textContent = 'Bill this invoice:';
                inputDiv.appendChild(label);
                const input = document.createElement('input');
                input.type = 'number';
                input.id = 'invoice-task-' + task.id;
                input.min = '0';
                input.max = String(remaining);
                input.value = '0';
                input.step = '1';
                input.dataset.taskId = task.id;
                input.dataset.taskAmount = String(task.amount || 0);
                input.oninput = updateInvoiceTotal;
                inputDiv.appendChild(input);
                const percentLabel = document.createTextNode(' %');
                inputDiv.appendChild(percentLabel);
                taskEl.appendChild(inputDiv);

                listContainer.appendChild(taskEl);
            });

            updateInvoiceTotal();
            openModal('create-contract-invoice-modal');
        }

        function updateInvoiceTotal() {
            let total = 0;
            const inputs = document.querySelectorAll('#contract-invoice-tasks-list input[type="number"]');
            inputs.forEach(function(input) {
                const percent = parseFloat(input.value) || 0;
                const amount = parseFloat(input.dataset.taskAmount) || 0;
                total += amount * percent / 100;
            });
            document.getElementById('contract-invoice-total').textContent = '$' + total.toLocaleString();
        }

        async function submitContractInvoice() {
            if (!currentContractForInvoice) return;

            // Send ALL tasks so they all appear on the invoice
            const tasks = [];
            const inputs = document.querySelectorAll('#contract-invoice-tasks-list input[type="number"]');
            inputs.forEach(function(input) {
                const percent = parseFloat(input.value) || 0;
                tasks.push({
                    task_id: input.dataset.taskId,
                    percent_this_invoice: percent
                });
            });

            if (tasks.every(function(t) { return t.percent_this_invoice === 0; })) {
                alert('Please enter a percentage for at least one task');
                return;
            }

            try {
                const response = await fetch(API_BASE + '/contracts/' + currentContractForInvoice.id + '/invoices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tasks: tasks })
                });
                const data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to create invoice'));
                    return;
                }

                closeModal('create-contract-invoice-modal');
                currentContractForInvoice = null;

                // If we got a sheet URL, open it
                if (data.data_path) {
                    window.open(data.data_path, '_blank');
                }

                loadProject(); // Refresh
            } catch (error) {
                console.error('Failed to create invoice:', error);
                alert('Failed to create invoice');
            }
        }

        function createNewInvoice() {
            const contracts = (project.contracts || []).filter(function(c) {
                return (c.tasks || []).length > 0;
            });
            if (contracts.length === 0) {
                alert('No contracts with tasks found. Add tasks to a contract first.');
                return;
            }
            if (contracts.length === 1) {
                createInvoiceFromContract(contracts[0].id);
                return;
            }
            // Multiple contracts — let user pick
            var msg = 'Select a contract to invoice from:\n';
            contracts.forEach(function(c, i) {
                msg += '\n' + (i + 1) + '. ' + c.id + ' — $' + (c.total_amount || 0).toLocaleString() + ' (' + (c.tasks || []).length + ' tasks)';
            });
            var choice = prompt(msg + '\n\nEnter number:');
            if (!choice) return;
            var idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < contracts.length) {
                createInvoiceFromContract(contracts[idx].id);
            }
        }

        async function finalizeInvoice(invoiceId) {
            if (!confirm('Finalize this invoice? This will read amounts from the Google Sheet and generate a PDF.')) return;

            try {
                const response = await fetch(API_BASE + '/invoices/' + invoiceId + '/finalize', { method: 'POST' });
                const data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to finalize invoice'));
                    return;
                }
                loadProject();
            } catch (error) {
                console.error('Failed to finalize invoice:', error);
                alert('Failed to finalize invoice');
            }
        }

        async function sendInvoice(invoiceId) {
            if (!confirm('Send this invoice to the client?')) return;

            try {
                const response = await fetch(API_BASE + '/invoices/' + invoiceId + '/send', { method: 'POST' });
                const data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to send invoice'));
                    return;
                }
                alert('Invoice sent to: ' + (data.sent_to || []).join(', '));
                loadProject();
            } catch (error) {
                console.error('Failed to send invoice:', error);
                alert('Failed to send invoice');
            }
        }

        async function markPaid(invoiceId) {
            if (!confirm('Mark this invoice as paid?')) return;

            try {
                const response = await fetch(API_BASE + '/invoices/' + invoiceId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paid_status: 'paid' })
                });
                const data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to mark as paid'));
                    return;
                }
                loadProject();
            } catch (error) {
                console.error('Failed to mark as paid:', error);
                alert('Failed to mark as paid');
            }
        }

        async function processInvoice(invoiceId) {
            if (!confirm('Create the next invoice in the chain?')) return;

            try {
                const response = await fetch(API_BASE + '/invoices/' + invoiceId + '/create-next', { method: 'POST' });
                const data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to create next invoice'));
                    return;
                }
                // Open the new Google Sheet if available
                if (data.data_path && data.data_path.includes('google.com')) {
                    window.open(data.data_path, '_blank');
                }
                loadProject();
            } catch (error) {
                console.error('Failed to create next invoice:', error);
                alert('Failed to create next invoice');
            }
        }

        function openEditInvoiceLinks(invoiceId) {
            // Find the invoice
            const invoices = project.invoices || [];
            const inv = invoices.find(function(i) { return i.id === invoiceId; });
            if (!inv) return;

            document.getElementById('edit-links-invoice-id').value = invoiceId;
            document.getElementById('edit-links-data-path').value = inv.data_path || '';
            document.getElementById('edit-links-pdf-path').value = inv.pdf_path || '';
            openModal('edit-invoice-links-modal');
        }

        async function saveInvoiceLinks(event) {
            event.preventDefault();
            const invoiceId = document.getElementById('edit-links-invoice-id').value;
            const dataPath = document.getElementById('edit-links-data-path').value;
            const pdfPath = document.getElementById('edit-links-pdf-path').value;

            try {
                const response = await fetch(API_BASE + '/invoices/' + invoiceId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data_path: dataPath || null, pdf_path: pdfPath || null })
                });
                const data = await response.json();
                if (!response.ok) {
                    alert('Error: ' + (data.detail || 'Failed to update links'));
                    return;
                }
                closeModal('edit-invoice-links-modal');
                loadProject();
            } catch (error) {
                console.error('Failed to update invoice links:', error);
                alert('Failed to update links');
            }
        }

        // --- Tasks ---
        let projectTasks = [];
        let allEmployees = [];
        let currentTaskFilter = 'all';
        let expandedTasks = new Set();

        async function loadEmployees() {
            try {
                const resp = await fetch(API_BASE + '/employees');
                allEmployees = await resp.json();
            } catch (e) {
                console.error('Failed to load employees:', e);
                allEmployees = [];
            }
        }

        async function loadTasks() {
            if (!jobId) return;
            try {
                const resp = await fetch(API_BASE + '/projects/' + encodeURIComponent(jobId) + '/tasks');
                projectTasks = await resp.json();
            } catch (e) {
                console.error('Failed to load tasks:', e);
                projectTasks = [];
            }
        }

        function setTaskFilter(filter) {
            currentTaskFilter = filter;
            document.querySelectorAll('.task-filter').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderTasks();
        }

        function filterTasks(tasks) {
            if (currentTaskFilter === 'all') return tasks;
            return tasks.filter(function(t) { return t.status === currentTaskFilter; });
        }

        function renderTasks() {
            const container = document.getElementById('tasks-list');
            container.textContent = '';

            const filtered = filterTasks(projectTasks);

            if (filtered.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = projectTasks.length === 0 ? 'No tasks yet' : 'No tasks match this filter';
                container.appendChild(empty);
                return;
            }

            filtered.forEach(function(task) {
                container.appendChild(renderTaskCard(task, false));
            });
        }

        function renderTaskCard(task, isSubtask) {
            const card = document.createElement('div');
            card.className = isSubtask ? 'task-subtask' : 'task-card';

            // Header
            const header = document.createElement('div');
            header.className = 'task-header';

            const left = document.createElement('div');
            left.style.cssText = 'display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;';

            // Status checkbox (quick toggle)
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = task.status === 'done';
            checkbox.style.cssText = 'accent-color: #4ade80; cursor: pointer;';
            checkbox.onclick = function(e) {
                e.stopPropagation();
                toggleTaskDone(task);
            };
            left.appendChild(checkbox);

            const titleSpan = document.createElement('span');
            titleSpan.className = 'text-white font-medium';
            titleSpan.style.cssText = task.status === 'done' ? 'text-decoration: line-through; opacity: 0.6;' : '';
            titleSpan.textContent = task.title;
            left.appendChild(titleSpan);

            const statusSpan = document.createElement('span');
            statusSpan.className = 'task-status task-status-' + task.status;
            statusSpan.textContent = formatTaskStatus(task.status);
            left.appendChild(statusSpan);

            header.appendChild(left);

            const right = document.createElement('div');
            right.style.cssText = 'display: flex; align-items: center; gap: 8px;';

            // Assignee names
            if (task.assignees && task.assignees.length > 0) {
                const assigneeSpan = document.createElement('span');
                assigneeSpan.className = 'text-gray-500 text-xs';
                assigneeSpan.textContent = task.assignees.map(function(a) { return a.first_name; }).join(', ');
                right.appendChild(assigneeSpan);
            }

            // Dates: show start → due range if both exist, otherwise just whichever exists
            if (task.start_date || task.due_date) {
                const dueSpan = document.createElement('span');
                dueSpan.className = 'text-gray-500 text-xs';
                var isOverdue = false;
                if (task.due_date) {
                    var dueDate = new Date(task.due_date + 'T00:00:00');
                    isOverdue = dueDate < new Date() && task.status !== 'done';
                }
                if (isOverdue) dueSpan.style.color = '#ff6b6b';
                if (task.start_date && task.due_date) {
                    dueSpan.textContent = formatDate(task.start_date) + ' → ' + formatDate(task.due_date);
                } else if (task.due_date) {
                    dueSpan.textContent = 'Due ' + formatDate(task.due_date);
                } else {
                    dueSpan.textContent = 'Started ' + formatDate(task.start_date);
                }
                right.appendChild(dueSpan);
            }

            if (!isSubtask) {
                const expandIcon = document.createElement('span');
                expandIcon.className = 'expand-icon' + (expandedTasks.has(task.id) ? ' expanded' : '');
                expandIcon.textContent = '\u25BC';
                right.appendChild(expandIcon);
            }

            header.appendChild(right);

            if (!isSubtask) {
                header.onclick = function() {
                    if (expandedTasks.has(task.id)) {
                        expandedTasks.delete(task.id);
                    } else {
                        expandedTasks.add(task.id);
                    }
                    renderTasks();
                };
            }

            card.appendChild(header);

            // Expanded detail
            if (!isSubtask && expandedTasks.has(task.id)) {
                const detail = document.createElement('div');
                detail.className = 'task-detail';

                // Description
                if (task.description) {
                    const desc = document.createElement('p');
                    desc.className = 'text-gray-400 text-sm mb-4';
                    desc.textContent = task.description;
                    detail.appendChild(desc);
                }

                // Subtasks
                if (task.subtasks && task.subtasks.length > 0) {
                    const subHeader = document.createElement('div');
                    subHeader.className = 'text-gray-500 text-xs uppercase mb-2';
                    subHeader.textContent = 'Subtasks';
                    detail.appendChild(subHeader);
                    task.subtasks.forEach(function(st) {
                        detail.appendChild(renderTaskCard(st, true));
                    });
                }

                // Add Subtask button
                const subtaskBtn = document.createElement('button');
                subtaskBtn.className = 'btn btn-secondary btn-small mt-2 mb-4';
                subtaskBtn.textContent = '+ Subtask';
                subtaskBtn.onclick = function(e) {
                    e.stopPropagation();
                    openAddTaskModal(task.id);
                };
                detail.appendChild(subtaskBtn);

                // Notes
                const notesHeader = document.createElement('div');
                notesHeader.className = 'text-gray-500 text-xs uppercase mb-2 mt-2';
                notesHeader.textContent = 'Notes';
                detail.appendChild(notesHeader);

                if (task.notes && task.notes.length > 0) {
                    task.notes.forEach(function(note) {
                        const noteEl = document.createElement('div');
                        noteEl.className = 'flex justify-between items-start p-2 rounded bg-[#1a1a2e] mb-1';

                        const noteContent = document.createElement('div');
                        const noteText = document.createElement('div');
                        noteText.className = 'text-gray-300 text-sm';
                        noteText.textContent = note.content;
                        noteContent.appendChild(noteText);

                        const noteMeta = document.createElement('div');
                        noteMeta.className = 'text-gray-600 text-xs mt-1';
                        noteMeta.textContent = (note.author_name || 'Unknown') + ' \u00b7 ' + formatDate(note.created_at);
                        noteContent.appendChild(noteMeta);

                        noteEl.appendChild(noteContent);

                        const delNoteBtn = document.createElement('button');
                        delNoteBtn.className = 'btn btn-danger btn-small';
                        delNoteBtn.textContent = '\u00d7';
                        delNoteBtn.onclick = function(e) {
                            e.stopPropagation();
                            deleteTaskNote(note.id);
                        };
                        noteEl.appendChild(delNoteBtn);

                        detail.appendChild(noteEl);
                    });
                }

                // Add note input
                const noteRow = document.createElement('div');
                noteRow.className = 'flex gap-2 mt-2';

                const noteInput = document.createElement('input');
                noteInput.type = 'text';
                noteInput.placeholder = 'Add a note...';
                noteInput.className = 'flex-1 p-2 bg-dark-bg border border-dark-border rounded-md text-white text-sm focus:outline-none focus:border-primary placeholder:text-gray-600';
                noteInput.id = 'note-input-' + task.id;
                noteRow.appendChild(noteInput);

                const addNoteBtn = document.createElement('button');
                addNoteBtn.type = 'button';
                addNoteBtn.className = 'btn btn-primary btn-small';
                addNoteBtn.textContent = 'Add';
                addNoteBtn.onclick = function(e) {
                    e.stopPropagation();
                    addTaskNote(task.id);
                };
                noteRow.appendChild(addNoteBtn);
                detail.appendChild(noteRow);

                // Action buttons
                const actions = document.createElement('div');
                actions.className = 'flex gap-2 mt-4 pt-3 border-t border-[#333]';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary btn-small';
                editBtn.textContent = 'Edit';
                editBtn.onclick = function(e) {
                    e.stopPropagation();
                    openEditTaskModal(task);
                };
                actions.appendChild(editBtn);

                const delBtn = document.createElement('button');
                delBtn.className = 'btn btn-danger btn-small';
                delBtn.textContent = 'Delete';
                delBtn.onclick = function(e) {
                    e.stopPropagation();
                    deleteTask(task.id);
                };
                actions.appendChild(delBtn);

                detail.appendChild(actions);
                card.appendChild(detail);
            }

            return card;
        }

        function formatTaskStatus(status) {
            var labels = {
                'todo': 'Todo', 'in_progress': 'In Progress',
                'blocked': 'Blocked', 'done': 'Done', 'canceled': 'Canceled'
            };
            return labels[status] || status;
        }

        async function toggleTaskDone(task) {
            var newStatus = task.status === 'done' ? 'todo' : 'done';
            try {
                await fetch(API_BASE + '/tasks/' + task.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                });
                await loadTasks();
                renderTasks();
            } catch (e) {
                console.error('Failed to toggle task:', e);
            }
        }

        function populateAssigneeCheckboxes(selectedIds) {
            const container = document.getElementById('task-assignees-checkboxes');
            container.textContent = '';
            allEmployees.forEach(function(emp) {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-1.5 text-gray-300 text-sm cursor-pointer';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = emp.id;
                cb.className = 'accent-primary';
                if (selectedIds && selectedIds.includes(emp.id)) cb.checked = true;
                label.appendChild(cb);

                const text = document.createTextNode(emp.first_name + ' ' + emp.last_name);
                label.appendChild(text);

                container.appendChild(label);
            });
        }

        function openAddTaskModal(parentId) {
            document.getElementById('task-modal-title').textContent = parentId ? 'Add Subtask' : 'Add Task';
            document.getElementById('task-form').reset();
            document.getElementById('task-edit-id').value = '';
            document.getElementById('task-parent-id').value = parentId || '';
            document.getElementById('task-status').value = 'todo';
            document.getElementById('task-start-date').value = new Date().toISOString().split('T')[0];
            populateAssigneeCheckboxes([]);
            openModal('task-modal');
        }

        function openEditTaskModal(task) {
            document.getElementById('task-modal-title').textContent = 'Edit Task';
            document.getElementById('task-edit-id').value = task.id;
            document.getElementById('task-parent-id').value = task.parent_id || '';
            document.getElementById('task-title').value = task.title || '';
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-status').value = task.status || 'todo';
            document.getElementById('task-start-date').value = task.start_date || '';
            document.getElementById('task-due-date').value = task.due_date || '';
            var selectedIds = (task.assignees || []).map(function(a) { return a.id; });
            populateAssigneeCheckboxes(selectedIds);
            openModal('task-modal');
        }

        function getSelectedAssigneeIds() {
            var ids = [];
            document.querySelectorAll('#task-assignees-checkboxes input[type="checkbox"]:checked').forEach(function(cb) {
                ids.push(cb.value);
            });
            return ids;
        }

        async function saveTask(event) {
            event.preventDefault();
            var taskId = document.getElementById('task-edit-id').value;
            var parentId = document.getElementById('task-parent-id').value || null;
            var body = {
                title: document.getElementById('task-title').value.trim(),
                description: document.getElementById('task-description').value.trim() || null,
                status: document.getElementById('task-status').value,
                start_date: document.getElementById('task-start-date').value || null,
                due_date: document.getElementById('task-due-date').value || null,
                assignee_ids: getSelectedAssigneeIds(),
            };

            if (!body.title) {
                alert('Title is required');
                return;
            }

            try {
                var url, method;
                if (taskId) {
                    url = API_BASE + '/tasks/' + taskId;
                    method = 'PATCH';
                } else {
                    url = API_BASE + '/projects/' + encodeURIComponent(jobId) + '/tasks';
                    method = 'POST';
                    body.parent_id = parentId;
                }

                var resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!resp.ok) {
                    var err = await resp.json();
                    alert('Error: ' + (err.detail || 'Failed to save task'));
                    return;
                }
                closeModal('task-modal');
                await loadTasks();
                renderTasks();
            } catch (e) {
                console.error('Failed to save task:', e);
                alert('Failed to save task');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            try {
                var resp = await fetch(API_BASE + '/tasks/' + taskId, { method: 'DELETE' });
                if (!resp.ok) {
                    alert('Failed to delete task');
                    return;
                }
                expandedTasks.delete(taskId);
                await loadTasks();
                renderTasks();
            } catch (e) {
                console.error('Failed to delete task:', e);
                alert('Failed to delete task');
            }
        }

        async function addTaskNote(taskId) {
            var input = document.getElementById('note-input-' + taskId);
            var content = input.value.trim();
            if (!content) return;

            try {
                var resp = await fetch(API_BASE + '/tasks/' + taskId + '/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content }),
                });
                if (!resp.ok) {
                    alert('Failed to add note');
                    return;
                }
                await loadTasks();
                renderTasks();
            } catch (e) {
                console.error('Failed to add note:', e);
            }
        }

        async function deleteTaskNote(noteId) {
            if (!confirm('Delete this note?')) return;
            try {
                var resp = await fetch(API_BASE + '/tasks/notes/' + noteId, { method: 'DELETE' });
                if (!resp.ok) {
                    alert('Failed to delete note');
                    return;
                }
                await loadTasks();
                renderTasks();
            } catch (e) {
                console.error('Failed to delete note:', e);
            }
        }

        // Load on page load — modified to load employees and tasks too
        async function init() {
            await loadEmployees();
            await loadProject();
            await loadTasks();
            renderTasks();
        }
        init();
    </script>
</body>
</html>
