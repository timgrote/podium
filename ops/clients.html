<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#6c63ff',
              'primary-hover': '#5a52d5',
              'dark-bg': '#1a1a2e',
              'dark-card': '#242442',
              'dark-border': '#444',
            }
          }
        }
      }
    </script>
    <title>Conductor - Clients</title>
    <style>
        .modal { display: none; }
        .modal.active { display: flex; }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #444;
            border-top-color: #6c63ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-dark-bg text-white font-sans min-h-screen leading-relaxed">
    <div class="max-w-[1200px] mx-auto px-5 py-10">
        <header class="flex justify-between items-center mb-10 max-md:flex-col max-md:items-start max-md:gap-4">
            <h1 class="text-3xl font-bold text-white">Clients <span class="bg-primary text-white px-3 py-1 rounded-full text-xs ml-2.5 align-middle">Directory</span></h1>
            <div class="header-actions flex gap-3 max-md:flex-col">
                <a href="dashboard.html" class="btn btn-secondary px-5 py-2.5 rounded-md text-sm font-medium cursor-pointer no-underline transition-all duration-200 bg-dark-card text-gray-400 border border-dark-border hover:bg-[#2d2d4a]">Dashboard</a>
                <button class="btn btn-primary px-5 py-2.5 rounded-md text-sm font-medium cursor-pointer transition-all duration-200 bg-primary text-white border-none hover:bg-primary-hover" onclick="openAddModal()">+ Add Client</button>
            </div>
        </header>

        <div class="section mb-10">
            <div class="search-box flex gap-3 mb-5">
                <input type="text" id="search-input" placeholder="Search by name, email, or company..." oninput="filterClients()" class="flex-1 px-4 py-2.5 bg-dark-bg border border-[#333] rounded-md text-white text-sm focus:outline-none focus:border-primary">
            </div>
            <div class="card bg-dark-card rounded-xl overflow-hidden">
                <div id="clients-loading" class="loading text-center p-10 text-gray-500">Loading clients</div>
                <div id="clients-grid" class="clients-grid grid grid-cols-[repeat(auto-fill,minmax(300px,1fr))] max-md:grid-cols-1 gap-5 p-5" style="display: none;"></div>
                <div id="clients-empty" class="empty-state text-center py-16 px-5 text-gray-600" style="display: none;">
                    <p class="mb-5">No clients yet. Add your first client to get started.</p>
                    <button class="btn btn-primary px-5 py-2.5 rounded-md text-sm font-medium cursor-pointer transition-all duration-200 bg-primary text-white border-none hover:bg-primary-hover" onclick="openAddModal()">+ Add Client</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div id="client-modal" class="modal fixed inset-0 bg-black/70 z-[1000] items-center justify-center">
        <div class="modal-content bg-dark-card rounded-xl p-8 max-w-[500px] w-[90%] max-h-[90vh] overflow-y-auto">
            <div class="modal-header flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-white text-xl font-semibold">Add Client</h3>
                <button class="modal-close bg-transparent border-none text-gray-500 text-2xl cursor-pointer" onclick="closeModal()">&times;</button>
            </div>
            <form id="client-form" onsubmit="saveClient(event)">
                <input type="hidden" id="client-id">
                <div class="form-group mb-4">
                    <label for="client-name" class="block text-gray-400 mb-1.5 text-sm">Name *</label>
                    <input type="text" id="client-name" required placeholder="e.g., Jim Birdsall" class="w-full px-3 py-2.5 bg-dark-bg border border-[#333] rounded-md text-white text-sm font-sans focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="form-group mb-4">
                    <label for="client-email" class="block text-gray-400 mb-1.5 text-sm">Email *</label>
                    <input type="email" id="client-email" required placeholder="e.g., jim@birdsall.com" class="w-full px-3 py-2.5 bg-dark-bg border border-[#333] rounded-md text-white text-sm font-sans focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="form-group mb-4">
                    <label for="client-company" class="block text-gray-400 mb-1.5 text-sm">Company</label>
                    <input type="text" id="client-company" placeholder="e.g., Birdsall Homes" class="w-full px-3 py-2.5 bg-dark-bg border border-[#333] rounded-md text-white text-sm font-sans focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="form-group mb-4">
                    <label for="client-phone" class="block text-gray-400 mb-1.5 text-sm">Phone</label>
                    <input type="tel" id="client-phone" placeholder="e.g., 555-123-4567" class="w-full px-3 py-2.5 bg-dark-bg border border-[#333] rounded-md text-white text-sm font-sans focus:outline-none focus:border-primary placeholder:text-gray-600">
                </div>
                <div class="form-group mb-4">
                    <label for="client-address" class="block text-gray-400 mb-1.5 text-sm">Address</label>
                    <textarea id="client-address" placeholder="Street address..." class="w-full px-3 py-2.5 bg-dark-bg border border-[#333] rounded-md text-white text-sm font-sans min-h-[100px] resize-y focus:outline-none focus:border-primary placeholder:text-gray-600"></textarea>
                </div>
                <div class="form-group mb-4">
                    <label for="client-notes" class="block text-gray-400 mb-1.5 text-sm">Notes</label>
                    <textarea id="client-notes" placeholder="Additional notes (supports markdown)..." class="w-full px-3 py-2.5 bg-dark-bg border border-[#333] rounded-md text-white text-sm font-sans min-h-[100px] resize-y focus:outline-none focus:border-primary placeholder:text-gray-600"></textarea>
                </div>
                <div class="modal-footer flex justify-between gap-3 mt-6 pt-5 border-t border-[#333]">
                    <div class="modal-footer-left flex gap-3">
                        <button type="button" id="delete-btn" class="btn btn-danger btn-small px-3 py-1.5 rounded-md text-xs font-medium cursor-pointer transition-all duration-200 bg-red-600 text-white border-none hover:bg-red-700" style="display: none;" onclick="deleteClient()">Delete</button>
                    </div>
                    <div class="modal-footer-right flex gap-3">
                        <button type="button" class="btn btn-secondary px-5 py-2.5 rounded-md text-sm font-medium cursor-pointer transition-all duration-200 bg-dark-card text-gray-400 border border-dark-border hover:bg-[#2d2d4a]" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary px-5 py-2.5 rounded-md text-sm font-medium cursor-pointer transition-all duration-200 bg-primary text-white border-none hover:bg-primary-hover">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const CLIENTS_API = '/api/clients';
        const PROJECTS_API = '/api/projects';

        let allClients = [];
        let allProjects = [];

        async function loadClients() {
            const loading = document.getElementById('clients-loading');
            const grid = document.getElementById('clients-grid');
            const empty = document.getElementById('clients-empty');

            try {
                const [clientsRes, projectsRes] = await Promise.all([
                    fetch(CLIENTS_API),
                    fetch(PROJECTS_API)
                ]);

                allClients = await clientsRes.json();
                allProjects = (await projectsRes.json()).map(p => ({
                    ...p,
                    job_id: p.job_id,
                }));

                loading.style.display = 'none';

                if (allClients.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                grid.style.display = 'grid';
                renderClients(allClients);

            } catch (error) {
                console.error('Failed to load clients:', error);
                loading.textContent = 'Failed to load clients. ';
                const retryBtn = document.createElement('button');
                retryBtn.className = 'btn btn-secondary px-5 py-2.5 rounded-md text-sm font-medium cursor-pointer transition-all duration-200 bg-dark-card text-gray-400 border border-dark-border hover:bg-[#2d2d4a]';
                retryBtn.textContent = 'Retry';
                retryBtn.onclick = () => location.reload();
                loading.appendChild(retryBtn);
            }
        }

        function renderClients(clients) {
            const grid = document.getElementById('clients-grid');
            // Clear existing
            while (grid.firstChild) {
                grid.removeChild(grid.firstChild);
            }

            clients.forEach(client => {
                const card = document.createElement('div');
                card.className = 'client-card bg-dark-bg rounded-lg p-5 cursor-pointer transition-all duration-200 border border-transparent hover:border-primary';
                card.onclick = () => openEditModal(client);

                const name = document.createElement('div');
                name.className = 'client-name text-[1.1rem] font-semibold text-white mb-1';
                name.textContent = client.name;
                card.appendChild(name);

                if (client.company) {
                    const company = document.createElement('div');
                    company.className = 'client-company text-primary text-sm mb-3';
                    company.textContent = client.company;
                    card.appendChild(company);
                }

                if (client.email) {
                    const emailDiv = document.createElement('div');
                    emailDiv.className = 'client-detail text-gray-500 text-[0.85rem] mb-1 flex items-center gap-2';
                    const emailLink = document.createElement('a');
                    emailLink.href = 'mailto:' + client.email;
                    emailLink.textContent = client.email;
                    emailLink.className = 'text-blue-400 no-underline hover:underline';
                    emailLink.onclick = (e) => e.stopPropagation();
                    emailDiv.appendChild(emailLink);
                    card.appendChild(emailDiv);
                }

                if (client.phone) {
                    const phoneDiv = document.createElement('div');
                    phoneDiv.className = 'client-detail text-gray-500 text-[0.85rem] mb-1 flex items-center gap-2';
                    phoneDiv.textContent = client.phone;
                    card.appendChild(phoneDiv);
                }

                if (client.notes) {
                    const notesDiv = document.createElement('div');
                    notesDiv.className = 'client-notes text-gray-500 text-[0.85rem] mt-3 pt-3 border-t border-[#333] italic';
                    notesDiv.textContent = client.notes.length > 100
                        ? client.notes.substring(0, 100) + '...'
                        : client.notes;
                    card.appendChild(notesDiv);
                }

                // Show linked projects
                const clientProjects = allProjects.filter(p =>
                    p.client_id === client.id ||
                    p.client_email?.toLowerCase() === client.email?.toLowerCase()
                );

                if (clientProjects.length > 0) {
                    const projectsDiv = document.createElement('div');
                    projectsDiv.className = 'client-projects mt-4 pt-3 border-t border-[#333]';

                    const title = document.createElement('div');
                    title.className = 'client-projects-title text-gray-500 text-xs uppercase mb-2';
                    title.textContent = 'Projects';
                    projectsDiv.appendChild(title);

                    clientProjects.forEach(proj => {
                        const link = document.createElement('a');
                        link.className = 'client-project-link inline-block bg-[#3b3b6d] text-[#a5a5ff] px-2.5 py-1 rounded text-xs mr-1.5 mb-1.5 no-underline hover:bg-[#4b4b7d]';
                        link.href = 'dashboard.html#' + proj.job_id;
                        link.textContent = proj.job_id;
                        link.onclick = (e) => e.stopPropagation();
                        projectsDiv.appendChild(link);
                    });

                    card.appendChild(projectsDiv);
                }

                grid.appendChild(card);
            });
        }

        function filterClients() {
            const query = document.getElementById('search-input').value.toLowerCase();
            if (!query) {
                renderClients(allClients);
                return;
            }

            const filtered = allClients.filter(c =>
                c.name.toLowerCase().includes(query) ||
                (c.email && c.email.toLowerCase().includes(query)) ||
                (c.company && c.company.toLowerCase().includes(query))
            );
            renderClients(filtered);
        }

        function openAddModal() {
            document.getElementById('modal-title').textContent = 'Add Client';
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
            document.getElementById('delete-btn').style.display = 'none';
            document.getElementById('client-modal').classList.add('active');
        }

        function openEditModal(client) {
            document.getElementById('modal-title').textContent = 'Edit Client';
            document.getElementById('client-id').value = client.id;
            document.getElementById('client-name').value = client.name || '';
            document.getElementById('client-email').value = client.email || '';
            document.getElementById('client-company').value = client.company || '';
            document.getElementById('client-phone').value = client.phone || '';
            document.getElementById('client-address').value = client.address || '';
            document.getElementById('client-notes').value = client.notes || '';
            document.getElementById('delete-btn').style.display = 'block';
            document.getElementById('client-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('client-modal').classList.remove('active');
        }

        document.getElementById('client-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) closeModal();
        });

        async function saveClient(event) {
            event.preventDefault();

            const id = document.getElementById('client-id').value;

            const payload = {
                name: document.getElementById('client-name').value.trim(),
                email: document.getElementById('client-email').value.trim(),
                company: document.getElementById('client-company').value.trim(),
                phone: document.getElementById('client-phone').value.trim(),
                address: document.getElementById('client-address').value.trim(),
                notes: document.getElementById('client-notes').value.trim()
            };

            try {
                let url = CLIENTS_API;
                let method = 'POST';
                if (id) {
                    url = CLIENTS_API + '/' + encodeURIComponent(id);
                    method = 'PATCH';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    closeModal();
                    location.reload();
                } else {
                    const result = await response.json();
                    alert('Error: ' + (result.detail || 'Failed to save client'));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save client. Please try again.');
            }
        }

        async function deleteClient() {
            const id = document.getElementById('client-id').value;
            const name = document.getElementById('client-name').value;

            if (!confirm('Delete client "' + name + '"? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(CLIENTS_API + '/' + encodeURIComponent(id), {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeModal();
                    location.reload();
                } else {
                    const result = await response.json();
                    alert('Error: ' + (result.detail || 'Failed to delete client'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete client. Please try again.');
            }
        }

        // Load on page load
        loadClients();
    </script>
</body>
</html>
